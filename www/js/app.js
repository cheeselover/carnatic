(function(){angular.module("carnatic",["ionic","firebase","contenteditable","carnatic.controllers","carnatic.services","carnatic.models","carnatic.directives"]).run(["$ionicPlatform","$rootScope","$state","Auth",function(r,t,e,n){return r.ready(function(){return window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar?StatusBar.styleDefault():void 0}),t.$on("$stateChangeStart",function(r,t){return"app"===t.name.substring(0,3)?n.authRef.$waitForAuth().then(function(r){return null==r?e.go("login"):void 0}):void 0}),t.logout=function(){return n.logout(),location.reload()}}]).value("REF",new Firebase("https://carnatic.firebaseio.com/")),angular.module("carnatic.controllers",[]),angular.module("carnatic.services",[]),angular.module("carnatic.models",[]),angular.module("carnatic.directives",[]),String.prototype.repeat=function(r){return new Array(r+1).join(this)},String.prototype.replaceAll=function(r,t){return this.replace(new RegExp(r,"g"),t)},Array.prototype.removeDuplicates=function(){return this.reduce(function(r,t){return r.indexOf(t)<0&&r.push(t),r},[])}}).call(this);
(function(){angular.module("carnatic").config(["$stateProvider","$urlRouterProvider",function(e,t){return e.state("login",{url:"/login",templateUrl:"templates/loginView.html",controller:"LoginCtrl"}).state("register",{url:"/register",templateUrl:"templates/registerView.html",controller:"RegisterCtrl"}).state("app",{url:"/app","abstract":!0,templateUrl:"templates/menu.html"}).state("app.compose",{url:"/compose",views:{menuContent:{templateUrl:"templates/composeView.html",controller:"ComposeCtrl",resolve:{korvais:["Auth",function(e){return e.user.korvais()}]}}}}).state("app.korvais",{url:"/korvais",views:{menuContent:{templateUrl:"templates/korvaisView.html",controller:"KorvaisCtrl",resolve:{korvais:["Auth",function(e){return e.user.korvais()}]}}}}).state("app.korvai-detail",{url:"/korvais/:korvaiId",views:{menuContent:{templateUrl:"templates/korvaiDetailView.html",controller:"KorvaiDetailCtrl",resolve:{korvai:["$stateParams","$q","Auth",function(e,t,r){var l;return l=t.defer(),l.resolve(r.user.korvais().then(function(t){return t.$getRecord(e.korvaiId)})),l.promise}]}}}}).state("app.account",{url:"/account",views:{menuContent:{templateUrl:"templates/accountView.html",controller:"AccountCtrl",resolve:{userProfile:["Auth",function(e){return e.user.userProfile()}],friends:["Auth",function(e){return e.user.friends()}]}}}}).state("app.search",{url:"/search",views:{menuContent:{templateUrl:"templates/searchView.html",controller:"SearchCtrl",resolve:{userProfiles:["UserProfileList",function(e){return new e("public").$loaded()}]}}}}),t.otherwise("/app/compose")}])}).call(this);
(function(){angular.module("carnatic.controllers").controller("AccountCtrl",["$scope","userProfile","friends",function(r,e,n){return r.userProfile=e,r.friends=n,r.updateProfile=function(r){return""!==r.name?(r.$priority=r.is_public?"public":"private",r.$save(),alert("Updated profile!")):alert("Name cannot be blank.")}}])}).call(this);
(function(){angular.module("carnatic.controllers").controller("ComposeCtrl",["$scope","MatrasService","KorvaiRenderService","korvais",function(a,t,r,o){var n;return a.korvai={content:"thathinkinathom,<br>(thathinkinathom /2),<br>(thathinkinathom /3)",thalam:"32",mod:0},a.totalMatras=32,n=parseInt(a.korvai.thalam),a.avarthanams=Math.floor(a.totalMatras/n),a.beats=Math.floor(a.totalMatras%n/4),a.matras=a.totalMatras%4,a.korvaiPreview=r.renderHTML(r.grabContent(a.korvai.content)),a.createKorvai=function(a){var t;return t=r.grabContent(a.content),""!==t?o.$add({content:t,thalam:parseInt(a.thalam),mod:parseInt(a.mod)}):void 0},a.updateMatras=function(){return a.totalMatras=t.countMatras(a.korvai.content,!0),a.avarthanams=Math.floor(a.totalMatras/n),a.beats=Math.floor(a.totalMatras%n/4),a.matras=a.totalMatras%4,a.korvaiPreview=r.renderHTML(r.grabContent(a.korvai.content)),a.$apply()}}])}).call(this);
(function(){angular.module("carnatic.controllers").controller("KorvaisCtrl",["$scope","$ionicActionSheet","$ionicModal","Auth","KorvaiList","korvais",function(e,r,t,n,a,o){var i;return e.korvais=o,t.fromTemplateUrl("templates/shareKorvaiModal.html",{scope:e,animation:"slide-in-up"}).then(function(r){return e.modal=r}),i=function(r){return e.korvai=r,n.user.friends().then(function(r){return e.friends=r,e.modal.show()})},e.friendClicked=function(r){return e.friendSelected=r},e.share=function(){return new a(e.friends[e.friendSelected].$value).$loaded().then(function(r){return r.$add(e.korvai)})},e.thalamString=function(e){var r;switch(r="",e){case 32:r="adi";break;case 12:r="rupaka";break;case 14:r="misra chapu";break;case 10:r="kanda chapu";break;default:r="unknown"}return r+" thalam, "},e.modString=function(e){var r;return r=0>e?" after":" before",Math.abs(e).toString()+r+" samam"},e.showActions=function(t){return r.show({buttons:[{text:"Share"}],destructiveText:"Delete",titleText:"Korvai Actions",cancelText:"Cancel",destructiveButtonClicked:function(){return confirm("Are you sure you want to delete this korvai?")&&e.korvais.$remove(t),!0},buttonClicked:function(e){return 0===e&&i(t),!0}})}}]).controller("KorvaiDetailCtrl",["$scope","KorvaiRenderService","korvai",function(e,r,t){return e.korvai=t,e.htmlKorvai=r.renderHTML(t.content)}])}).call(this);
(function(){angular.module("carnatic.controllers").controller("LeftMenuCtrl",["$scope","Auth",function(r,e){return e.user.userProfile().then(function(e){return r.userProfile=e})}])}).call(this);
(function(){angular.module("carnatic.controllers").controller("LoginCtrl",["$scope","$state","Auth",function(n,t,o){return n.auth=o,n.user=n.auth.currentUser,n.loginWithEmail=function(n){return o.loginEmail({email:n.email,password:n.password},{remember:"sessionOnly"}).then(function(){return t.go("app.compose")})["catch"](function(n){return alert("Authentication failed: "+n)})},n.loginWithFacebook=function(){return o.loginOAuth("facebook",{remember:"sessionOnly"}).then(function(){return t.go("app.compose")})["catch"](function(n){return alert("Authentication failed: "+n)})},n.loginWithGoogle=function(){return o.loginOAuth("google",{remember:"sessionOnly"}).then(function(){return t.go("app.compose")})["catch"](function(n){return alert("Authentication failed: "+n)})},n.logout=function(){return n.auth.logout(),location.reload()}}])}).call(this);
(function(){angular.module("carnatic.controllers").controller("RegisterCtrl",["$scope","$state","Auth","REF",function(r,e,t,a){return r.register=function(r){return r.password===r.password_confirm?t.createUser(r.email,r.password)["catch"](function(r){if(r)switch(r.code){case"EMAIL_TAKEN":alert("Email already in use.");break;case"INVALID EMAIL":alert("Email not valid");break;default:return alert("Error creating user: "+r)}}).then(function(){return t.loginEmail({email:r.email,password:r.password},{remember:"sessionOnly"}).then(function(t){var n;return n=a.child("user_profiles/"+t.uid),n.update({name:r.name}),n.setPriority("public"),e.go("app.compose")})})["catch"](function(r){return alert("Authentication failed: "+r)}):alert("Password did not match confirmation.")}}])}).call(this);
(function(){angular.module("carnatic.controllers").controller("RightMenuCtrl",["$scope",function(a){return a.thalams=[{name:"Adi",value:32},{name:"Rupakam",value:12},{name:"Misra chapu",value:14},{name:"Kanda chapu",value:10}],a.mods=[{name:"None",value:0},{name:"2 matras before",value:2},{name:"4 matras before",value:4},{name:"6 matras before",value:6},{name:"2 matras after",value:-2},{name:"4 matras after",value:-4},{name:"6 matras after",value:-6}]}])}).call(this);
(function(){angular.module("carnatic.controllers").controller("SearchCtrl",["$scope","Auth","REF","userProfiles",function(r,e,n,u){return r.userProfiles=u,r.addFriend=function(r){var u;return u=e.currentUser.uid,r.$id!==u?n.child("friends/"+u).push(r.$id):alert("You can't add yourself as a friend!")}}])}).call(this);
(function(){angular.module("carnatic.directives").directive("arcTween",function(){return{restrict:"E",scope:{val:"=",thalam:"=",mod:"="},link:function(t,n){var a,e,r,i,l,d,u,o,c,s;return s=$(n[0]).parent().height()+40,i=s/10,o=s/2-i,u=2*Math.PI,a=d3.svg.arc().innerRadius(s/4).outerRadius(s/4+i).startAngle(0),d=d3.select(n[0]).append("svg").attr("width",s).attr("height",s).append("g").attr("transform","translate("+o+","+o+")"),r=d.append("path").datum({endAngle:u}).style("fill","#ddd").attr("d",a),l=d.append("path").datum({endAngle:u}).style("fill","green").attr("d",a),c=function(t,n,a){var r;return r=Math.abs(t-a)%n/n,0===r?(l.style("fill","green"),l.transition().duration(500).call(e,u)):(l.style("fill","orange"),l.transition().duration(500).call(e,r*u))},t.$watch("val",function(n,a){return n!==a?c(n,t.thalam,t.mod):void 0}),t.$watch("thalam",function(n,a){return n!==a?c(t.val,n,t.mod):void 0}),t.$watch("mod",function(n,a){return n!==a?c(t.val,t.thalam,n):void 0}),e=function(t,n){return t.attrTween("d",function(t){var e;return e=d3.interpolate(t.endAngle,n),function(n){return t.endAngle=e(n),a(t)}})}}}})}).call(this);
(function(){angular.module("carnatic.directives").directive("composeKorvai",["$document",function(t){var e;return e=function(t){return t.match(/([a-zA-Z]+)/g).removeDuplicates().filter(function(t){return t.length>2})},{restrict:"A",link:function(n,r){return t.ready(function(){var t,a;return $(r[0]).keydown(function(t){return 13===t.keyCode?(document.execCommand("insertHTML",!1,"<br><br>"),!1):void 0}),a=null,$(r[0]).keyup(function(){return clearTimeout(a),a=setTimeout(n.updateMatras,1e3)}),t=e(r[0].textContent),t=$.map(t,function(t){return{key:t,name:t}}),$(r[0]).atwho({at:'"',data:t,displayTpl:"<li>${name}</li>",insertTpl:"${key}",startWithSpace:!1}),$(r[0]).on("shown.atwho",function(){return t=e(r[0].textContent),t=$.map(t,function(t){return{key:t,name:t}}),$(r[0]).atwho({at:'"',data:t,displayTpl:"<li>${name}</li>",insertTpl:"${key}",startWithSpace:!1})})})}}}])}).call(this);
(function(){angular.module("carnatic.models").factory("Friends",["$firebase","REF",function(n,r){return function(a){return n(r.child("friends/"+a)).$asArray()}}])}).call(this);
(function(){angular.module("carnatic.models").factory("KorvaiList",["$firebase","REF",function(r,a){return function(i){return r(a.child("korvais/"+i)).$asArray()}}])}).call(this);
(function(){angular.module("carnatic.models").factory("UserProfile",["$firebase","REF",function(r,e){return function(t){return r(e.child("user_profiles/"+t)).$asObject()}}]).factory("UserProfileList",["$firebase","REF",function(r,e){return function(t){return r(e.child("user_profiles").startAt(t).endAt(t)).$asArray()}}])}).call(this);
(function(){angular.module("carnatic.models").factory("User",["$firebase","KorvaiList","UserProfile","Friends",function(r,e,n,t){var o;return o=function(){function r(r){this.userId=r}return r.prototype.userProfile=function(){return new n(this.userId).$loaded()},r.prototype.korvais=function(){return new e(this.userId).$loaded()},r.prototype.friends=function(){return new t(this.userId).$loaded()},r}()}])}).call(this);
(function(){angular.module("carnatic.services").factory("Auth",["$firebaseAuth","$rootScope","User","REF",function(e,r,o,a){var i,t,u;return t=e(a),u=a.child("users"),i={createUser:t.$createUser,logout:t.$unauth,loginEmail:t.$authWithPassword,loginOAuth:t.$authWithOAuthPopup,authRef:t},t.$onAuth(function(e){return e?(i.currentUser=e,i.user=new o(e.uid),u.child(e.uid).once("value",function(r){var o,i;return null==r.val()?(u.child(e.uid).set(e),i=a.child("user_profiles/"+e.uid),o=e.provider,i.update("facebook"===o?{name:e.facebook.displayName,picture:e.facebook.cachedUserProfile.picture.data.url}:"google"===o?{name:e.google.displayName,picture:e.google.cachedUserProfile.picture}:{email:e.password.email,picture:"https://www.gravatar.com/avatar/"+CryptoJS.MD5(e.password.email)+"?d=retro"})):void 0})):window.cookies?window.cookies.clear():void 0}),i}])}).call(this);
(function(){angular.module("carnatic.services").factory("KorvaiRenderService",["$sce","MatrasService",function(e,r){return{renderHTML:function(r){return e.trustAsHtml(this.korvaiToHTML(r))},convertRepeater:function(e){var a,n,t,s,i,c;if(n=e.lastIndexOf("/"),-1!==n){for(t=e.substring(0,n),s=r.findModifiers(t,"(",")"),i=0,c=s.length;c>i;i++)a=s[i],t=this.replaceRepeater(t,a);return'<span class="modifier-bracket">(</span> '+t+' <span class="modifier-bracket">)</span> ×'+parseInt(e.slice(n+1))+" "}},replaceRepeater:function(e,r){return e.replace("("+r+")",this.convertRepeater(r))},convertNadai:function(e){var r,a;return r=e.lastIndexOf("/"),-1!==r?(a=e.substring(0,r),'<span class="modifier-bracket">[</span> '+a+' <span class="modifier-bracket">]</span> → '+this.numberToNadai(parseInt(e.slice(r+1)))+" "):void 0},numberToNadai:function(e){switch(e){case 3:return"thisram";case 4:return"chatusram";case 5:return"kandam";case 6:return"mael thisram";case 7:return"misram";case 8:return"mael chatusram";case 9:return"sankeernam"}},grabContent:function(e){var r;return e=e.replaceAll("<br>","\n"),r=document.createElement("div"),r.innerHTML=e,e=r.textContent||r.innerText||""},korvaiToHTML:function(e){var a,n,t,s,i,c,l,o,u,p,f,d;if(""===e||null===e)return"";for(e=e.replaceAll(","," , ").replaceAll(";"," ; ").replaceAll("\n"," \n "),a=e.match(/([a-zA-Z]+)/g).removeDuplicates(),l=0,p=a.length;p>l;l++)c=a[l],e=e.replaceAll("\\b"+c+"\\b"," "+c+"<sup>"+r.wordMatras(c)+"</sup> ");for(i=r.findModifiers(e,"(",")"),o=0,f=i.length;f>o;o++)s=i[o],e=e.replace("("+s+")",this.convertRepeater(s));for(t=r.findModifiers(e,"[","]"),u=0,d=t.length;d>u;u++)n=t[u],e=e.replace("["+n+"]",this.convertNadai(n));return e=e.replaceAll("\n","<br>")}}}])}).call(this);
(function(){angular.module("carnatic.services").factory("MatrasService",function(){return{findModifiers:function(t,r,e){var a,n,i,s,o;for(n=-1,i=[];;){for(;t.charAt(n+1)!==r&&n<t.length;)n++;if(n===t.length)break;for(s=0,o=n;;)if(a=t.charAt(++n),a===r?s++:a===e&&s--,!(s>0&&n<t.length))break;if(n===t.length)break;i.push(t.substring(o+2,n))}return i},repeatString:function(t){var r,e,a,n,i,s,o,f;if(a=t.lastIndexOf("/"),-1!==a){for(i=t.substring(0,a),s=this.findModifiers(i,"(",")"),o=0,f=s.length;f>o;o++)e=s[o],i=this.replaceRepeater(i,e);n=parseInt(t.slice(a+1));try{return i.repeat(n)}catch(c){return r=c,alert("ERROR: Invalid repeater syntax."),i}}},replaceRepeater:function(t,r){return t.replace("("+r+")",this.repeatString(r))},repeaterMatras:function(t){return this.matrasWithoutModifiers(this.repeatString(t))},nadaiMatras:function(t){var r,e;return r=t.lastIndexOf("/"),-1!==r?(e=t.substring(0,r),4*this.countMatras(e,!1)/parseInt(t.slice(r+1))):void 0},wordMatras:function(t){var r;return r=t.match(/[aeiou]/g),r?r.length:0},matrasWithoutModifiers:function(t){var r,e,a,n,i,s,o;for(a=0,e=t.replace(/(\r\n|\n|\r)/gm," ").split(" "),s=0,o=e.length;o>s;s++)i=e[s],a+=this.wordMatras(i);return r=t.match(/,/g),a+=r?r.length:0,n=t.match(/;/g),a+=n?2*n.length:0},countMatras:function(t,r){var e,a,n,i,s,o,f,c,h,u;if(e=document.createElement("div"),e.innerHTML=t,t=e.textContent||e.innerText||"",a=0,r)for(i=this.findModifiers(t,"[","]"),f=0,h=i.length;h>f;f++)n=i[f],a+=this.nadaiMatras(n),t=t.replace("["+n+"]","");for(o=this.findModifiers(t,"(",")"),c=0,u=o.length;u>c;c++)s=o[c],a+=this.repeaterMatras(s),t=t.replace("("+s+")","");return a+=this.matrasWithoutModifiers(t)}}})}).call(this);